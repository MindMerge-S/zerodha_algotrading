<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zerodha Trading Terminal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.9em;
    }

    .content {
      padding: 30px;
    }

    .status-bar {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dc3545;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #28a745;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .section {
      margin-bottom: 25px;
    }

    .section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    textarea {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      resize: vertical;
      font-family: 'Courier New', monospace;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    #output {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      min-height: 150px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      border: 2px solid #e0e0e0;
    }

    #output.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }

    #output.success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }

    #output.info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #bee5eb;
    }

    .examples {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .examples h4 {
      margin-bottom: 10px;
      color: #667eea;
    }

    .examples code {
      display: block;
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin: 5px 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .examples code:hover {
      background: #e9ecef;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .quote-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .quote-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      text-align: center;
    }

    .quote-card .label {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
    }

    .quote-card .value {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìà Zerodha Trading Terminal</h1>
    <p>Natural Language Trading Interface</p>
  </div>

  <div class="content">
 
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <span id="serverUrl">http://127.0.0.1:8000</span>
    </div>


    <div class="section">
      <h3>üìù Place Trade</h3>
      <textarea id="cmd" rows="3" placeholder="Enter your trade command...">buy 10 hdfc</textarea>
      
      <div class="button-group">
        <button class="btn-primary" onclick="placeTrade()">Place Trade</button>
        <button class="btn-info" onclick="getQuote()">Get Quote</button>
        <button class="btn-secondary" onclick="getPositions()">Positions</button>
        <button class="btn-secondary" onclick="getOrders()">Orders</button>
      </div>

      <div class="examples">
        <h4>üí° Example Commands:</h4>
        <code onclick="setCommand(this)">buy 10 hdfc</code>
        <code onclick="setCommand(this)">sell 5 reliance</code>
        <code onclick="setCommand(this)">buy 20 tcs</code>
        <code onclick="setCommand(this)">sell 15 infosys</code>
      </div>
    </div>

    
    <div class="section">
      <h3>üìä Output</h3>
      <pre id="output">Ready to trade... Click "Test Connection" to verify server status.</pre>
    </div>

   
    <div class="section" id="quoteSection" style="display: none;">
      <h3>üíπ Live Quote</h3>
      <div class="quote-display" id="quoteDisplay"></div>
    </div>
  </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";
let isConnected = false;

// Set command from example
function setCommand(element) {
  document.getElementById("cmd").value = element.textContent;
}

// Update status indicator
function updateStatus(connected, message) {
  isConnected = connected;
  const dot = document.getElementById("statusDot");
  const text = document.getElementById("statusText");
  
  if (connected) {
    dot.classList.add("connected");
    text.textContent = message || "Connected";
  } else {
    dot.classList.remove("connected");
    text.textContent = message || "Disconnected";
  }
}

// Show output
function showOutput(text, type = "") {
  const output = document.getElementById("output");
  output.textContent = text;
  output.className = type;
}

// Test connection on page load
async function testConnection() {
  try {
    const res = await fetch(`${API_URL}/`);
    const data = await res.json();
    
    if (data.status === "online") {
      updateStatus(true, "Connected");
      showOutput("‚úì Server connected successfully!\n\n" + JSON.stringify(data, null, 2), "success");
    }
  } catch (err) {
    updateStatus(false, "Connection Failed");
    showOutput(
      "‚úó Cannot connect to server!\n\n" +
      "Error: " + err.message + "\n\n" +
      "Make sure the FastAPI server is running:\n" +
      "uvicorn api_server:app --reload --port 8000\n\n" +
      "Check browser console (F12) for more details.",
      "error"
    );
  }
}

// Place trade
async function placeTrade() {
  const command = document.getElementById("cmd").value.trim();
  
  if (!command) {
    showOutput("‚ö† Please enter a trade command", "error");
    return;
  }

  if (!isConnected) {
    showOutput("‚ö† Not connected to server. Testing connection...", "error");
    await testConnection();
    return;
  }

  showOutput("‚è≥ Placing trade...", "info");

  try {
    const res = await fetch(`${API_URL}/trade`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ command: command })
    });

    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput(
        "‚úó Trade Failed\n\n" +
        "Error: " + (data.error || data.message || "Unknown error") + "\n\n" +
        JSON.stringify(data, null, 2),
        "error"
      );
    } else {
      showOutput(
        "‚úì Trade Placed Successfully!\n\n" +
        `Order ID: ${data.order_id}\n` +
        `Symbol: ${data.symbol}\n` +
        `Quantity: ${data.quantity}\n` +
        `Type: ${data.transaction_type}\n\n` +
        JSON.stringify(data, null, 2),
        "success"
      );
    }
  } catch (err) {
    showOutput(
      "‚úó Request Failed\n\n" +
      "Error: " + err.message + "\n\n" +
      "Check browser console (F12) for details",
      "error"
    );
  }
}

// Get quote
async function getQuote() {
  const command = document.getElementById("cmd").value.trim();
  
  // Extract symbol from command
  const symbols = ["HDFCBANK", "ICICIBANK", "RELIANCE", "TCS", "INFY","Wipro"];
  let symbol = null;
  
  for (let s of symbols) {
    if (command.toLowerCase().includes(s.toLowerCase().substring(0, 4))) {
      symbol = s;
      break;
    }
  }

  if (!symbol) {
    showOutput("‚ö† Cannot detect symbol. Please include a stock name in your command.", "error");
    return;
  }

  showOutput("‚è≥ Fetching quote for " + symbol + "...", "info");

  try {
    const res = await fetch(`${API_URL}/quote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symbol: symbol })
    });

    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput(
        "‚úó Quote Fetch Failed\n\n" +
        "Error: " + (data.error || data.message) + "\n\n" +
        JSON.stringify(data, null, 2),
        "error"
      );
      document.getElementById("quoteSection").style.display = "none";
    } else {
      showOutput(
        "‚úì Quote Retrieved Successfully!\n\n" +
        JSON.stringify(data, null, 2),
        "success"
      );
      
      // Display quote in cards
      displayQuoteCards(data);
    }
  } catch (err) {
    showOutput("‚úó Request Failed\n\nError: " + err.message, "error");
    document.getElementById("quoteSection").style.display = "none";
  }
}

// Display quote in card format
function displayQuoteCards(data) {
  const quoteSection = document.getElementById("quoteSection");
  const quoteDisplay = document.getElementById("quoteDisplay");
  
  quoteDisplay.innerHTML = `
    <div class="quote-card">
      <div class="label">Last Price</div>
      <div class="value">‚Çπ${data.last_price}</div>
    </div>
    <div class="quote-card">
      <div class="label">Open</div>
      <div class="value">‚Çπ${data.open}</div>
    </div>
    <div class="quote-card">
      <div class="label">High</div>
      <div class="value">‚Çπ${data.high}</div>
    </div>
    <div class="quote-card">
      <div class="label">Low</div>
      <div class="value">‚Çπ${data.low}</div>
    </div>
    <div class="quote-card">
      <div class="label">Close</div>
      <div class="value">‚Çπ${data.close}</div>
    </div>
  `;
  
  quoteSection.style.display = "block";
}

// Get positions
async function getPositions() {
  showOutput("‚è≥ Fetching positions...", "info");

  try {
    const res = await fetch(`${API_URL}/positions`);
    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput(
        "‚úó Failed to fetch positions\n\n" +
        JSON.stringify(data, null, 2),
        "error"
      );
    } else {
      showOutput(
        "‚úì Positions Retrieved\n\n" +
        JSON.stringify(data, null, 2),
        "success"
      );
    }
  } catch (err) {
    showOutput("‚úó Request Failed\n\nError: " + err.message, "error");
  }
}

// Get orders
async function getOrders() {
  showOutput("‚è≥ Fetching orders...", "info");

  try {
    const res = await fetch(`${API_URL}/orders`);
    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput(
        "‚úó Failed to fetch orders\n\n" +
        JSON.stringify(data, null, 2),
        "error"
      );
    } else {
      showOutput(
        "‚úì Orders Retrieved\n\n" +
        JSON.stringify(data, null, 2),
        "success"
      );
    }
  } catch (err) {
    showOutput("‚úó Request Failed\n\nError: " + err.message, "error");
  }
}

// Test connection on page load
window.addEventListener('load', () => {
  console.log("Page loaded, testing connection...");
  testConnection();
});
</script>

</body>
</html>
 -->

 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zerodha Live Trading Terminal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f0f0f;
      color: #fff;
      overflow-x: hidden;
    }

    /* Top Ticker Bar */
    .ticker-bar {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      padding: 0;
      overflow: hidden;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .ticker-wrapper {
      display: flex;
      align-items: center;
      padding: 12px 0;
      animation: scroll 30s linear infinite;
      gap: 40px;
    }

    .ticker-wrapper:hover {
      animation-play-state: paused;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .ticker-item {
      display: flex;
      align-items: center;
      gap: 15px;
      white-space: nowrap;
      padding: 0 20px;
      border-right: 1px solid #333;
      min-width: fit-content;
    }

    .ticker-name {
      font-weight: 600;
      font-size: 13px;
      color: #aaa;
      min-width: 120px;
    }

    .ticker-price {
      font-weight: 700;
      font-size: 16px;
      color: #fff;
      min-width: 100px;
    }

    .ticker-change {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      font-weight: 600;
      min-width: 120px;
    }

    .ticker-change.positive {
      color: #00d09c;
    }

    .ticker-change.negative {
      color: #ff4757;
    }

    .arrow {
      font-size: 10px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .status-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #dc3545;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #00d09c;
    }

    .status-dot.market-open {
      background: #00d09c;
    }

    .status-dot.market-closed {
      background: #ffc107;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #333;
    }

    .panel h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Indices Grid */
    .indices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    @media (max-width: 768px) {
      .indices-grid {
        grid-template-columns: 1fr;
      }
    }

    .index-card {
      background: #252525;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      transition: all 0.3s;
      cursor: pointer;
    }

    .index-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .index-card.positive {
      border-left-color: #00d09c;
    }

    .index-card.negative {
      border-left-color: #ff4757;
    }

    .index-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .index-name {
      font-size: 1em;
      font-weight: 600;
      color: #aaa;
    }

    .index-price {
      font-size: 2em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .index-change {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1em;
      font-weight: 600;
    }

    .change-positive {
      color: #00d09c;
    }

    .change-negative {
      color: #ff4757;
    }

    .index-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #333;
    }

    .stat {
      text-align: center;
    }

    .stat-label {
      font-size: 0.75em;
      color: #666;
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 0.95em;
      font-weight: 600;
      color: #aaa;
    }

    /* Trading Panel */
    .trading-panel textarea {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      background: #252525;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
      resize: vertical;
      font-family: 'Courier New', monospace;
      margin-bottom: 15px;
    }

    .trading-panel textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #444;
      color: white;
    }

    .btn-secondary:hover {
      background: #555;
      transform: translateY(-2px);
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    #output {
      background: #252525;
      padding: 20px;
      border-radius: 8px;
      min-height: 150px;
      max-height: 350px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      border: 1px solid #333;
      color: #aaa;
    }

    #output.error {
      background: #2d1f1f;
      color: #ff4757;
      border-color: #ff4757;
    }

    #output.success {
      background: #1f2d1f;
      color: #00d09c;
      border-color: #00d09c;
    }

    #output.info {
      background: #1f2a2d;
      color: #17a2b8;
      border-color: #17a2b8;
    }

    .examples {
      background: #252525;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
    }

    .examples h4 {
      margin-bottom: 10px;
      color: #667eea;
    }

    .examples code {
      display: block;
      padding: 8px;
      background: #1a1a1a;
      border-radius: 4px;
      margin: 5px 0;
      cursor: pointer;
      transition: background 0.2s;
      color: #aaa;
    }

    .examples code:hover {
      background: #333;
      color: #fff;
    }

    .refresh-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
    }

    .refresh-control select {
      padding: 6px 12px;
      background: #252525;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .refresh-control button {
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .timestamp {
      font-size: 0.85em;
      color: #666;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>

<!-- Ticker Bar -->
<div class="ticker-bar">
  <div class="ticker-wrapper" id="tickerWrapper">
    <!-- Ticker items will be inserted here by JavaScript -->
    <div style="padding: 20px; color: #666;">Loading indices...</div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <h1>üìà Zerodha Live Trading Terminal</h1>
  <div class="status-bar">
    <div class="status-indicator">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
    <div class="status-indicator">
      <div class="status-dot market-closed" id="marketDot"></div>
      <span id="marketStatus">Market Closed</span>
    </div>
    <div class="status-indicator">
      <div class="status-dot connected" style="background: #00d09c;"></div>
      <span>Auto-Refresh ON</span>
    </div>
    <div class="timestamp" id="lastUpdate">Last: Never</div>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <div class="main-grid">
    
    <!-- Live Indices Panel -->
    <div class="panel">
      <h2>üìä Live Market Indices</h2>
      <div class="indices-grid" id="indicesGrid">
        <div style="text-align: center; padding: 40px; color: #666;">
          Loading indices data...
        </div>
      </div>
    </div>

    <!-- Trading Panel -->
    <div class="panel trading-panel">
      <h2>üíº Trading</h2>
      
      <textarea id="cmd" rows="3" placeholder="Enter trade command...">buy 10 hdfc</textarea>
      
      <div class="button-group">
        <button class="btn-primary" onclick="placeTrade()">Place Trade</button>
        <button class="btn-info" onclick="getQuote()">Get Quote</button>
        <button class="btn-secondary" onclick="getPositions()">Positions</button>
        <button class="btn-secondary" onclick="getOrders()">Orders</button>
      </div>

      <div class="examples">
        <h4>üí° Examples:</h4>
        <code onclick="setCommand(this)">buy 10 hdfc</code>
        <code onclick="setCommand(this)">sell 5 reliance</code>
        <code onclick="setCommand(this)">buy 20 tcs</code>
      </div>

      <h3 style="margin-bottom: 15px; color: #fff; font-size: 1.1em;">üìã Output</h3>
      <pre id="output">Ready to trade...</pre>
    </div>

  </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";
let isConnected = false;
let refreshIntervalId = null;
const AUTO_REFRESH_INTERVAL = 3000; // Fixed 3 seconds

// Format number
function formatNumber(num) {
  return num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Update ticker
function updateTicker(indices) {
  const ticker = document.getElementById("tickerWrapper");
  
  if (!indices || indices.length === 0) {
    ticker.innerHTML = '<div style="padding: 20px; color: #666;">No data available</div>';
    return;
  }
  
  // Create ticker items - duplicate for seamless loop
  const tickerItems = indices.concat(indices).map(index => {
    const isPositive = index.change >= 0;
    const changeClass = isPositive ? 'positive' : 'negative';
    const arrow = isPositive ? '‚ñ≤' : '‚ñº';
    
    return `
      <div class="ticker-item">
        <div class="ticker-name">${index.name}</div>
        <div class="ticker-price">${formatNumber(index.last_price)}</div>
        <div class="ticker-change ${changeClass}">
          <span class="arrow">${arrow}</span>
          <span>${isPositive ? '+' : ''}${formatNumber(index.change)}</span>
          <span>(${isPositive ? '+' : ''}${index.change_percent}%)</span>
        </div>
      </div>
    `;
  }).join('');
  
  ticker.innerHTML = tickerItems;
}

// Display indices cards
function displayIndices(indices) {
  const grid = document.getElementById("indicesGrid");
  
  if (!indices || indices.length === 0) {
    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No data available</div>';
    return;
  }
  
  grid.innerHTML = indices.map(index => {
    const isPositive = index.change >= 0;
    const changeClass = isPositive ? 'change-positive' : 'change-negative';
    const cardClass = isPositive ? 'positive' : 'negative';
    const arrow = isPositive ? '‚ñ≤' : '‚ñº';
    
    return `
      <div class="index-card ${cardClass}">
        <div class="index-header">
          <div class="index-name">${index.name}</div>
        </div>
        <div class="index-price">${formatNumber(index.last_price)}</div>
        <div class="index-change">
          <span class="${changeClass}">
            ${arrow} ${isPositive ? '+' : ''}${formatNumber(index.change)}
          </span>
          <span class="${changeClass}">
            (${isPositive ? '+' : ''}${index.change_percent}%)
          </span>
        </div>
        <div class="index-stats">
          <div class="stat">
            <div class="stat-label">Open</div>
            <div class="stat-value">${formatNumber(index.open)}</div>
          </div>
          <div class="stat">
            <div class="stat-label">High</div>
            <div class="stat-value">${formatNumber(index.high)}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Low</div>
            <div class="stat-value">${formatNumber(index.low)}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// AJAX refresh indices - automatically called every 3 seconds
function refreshIndices() {
  // Using XMLHttpRequest for AJAX
  const xhr = new XMLHttpRequest();
  xhr.open('GET', `${API_URL}/indices`, true);
  
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        const data = JSON.parse(xhr.responseText);
        
        if (data.status === "success") {
          updateTicker(data.indices);
          displayIndices(data.indices);
          updateMarketStatus(data.market_open);
          
          const now = new Date();
          document.getElementById("lastUpdate").textContent = 
            `Last: ${now.toLocaleTimeString()}`;
        }
      } catch (error) {
        console.error("Error parsing response:", error);
      }
    }
  };
  
  xhr.onerror = function() {
    console.error("AJAX request failed");
  };
  
  xhr.send();
}

// Start auto-refresh
function startAutoRefresh() {
  // Initial fetch
  refreshIndices();
  
  // Set interval for automatic refresh every 3 seconds
  refreshIntervalId = setInterval(refreshIndices, AUTO_REFRESH_INTERVAL);
  console.log(`Auto-refresh started: every ${AUTO_REFRESH_INTERVAL}ms`);
}

// Update status
function updateStatus(connected, message) {
  isConnected = connected;
  const dot = document.getElementById("statusDot");
  const text = document.getElementById("statusText");
  
  if (connected) {
    dot.classList.add("connected");
    text.textContent = message || "Connected";
  } else {
    dot.classList.remove("connected");
    text.textContent = message || "Disconnected";
  }
}

// Update market status
function updateMarketStatus(isOpen) {
  const dot = document.getElementById("marketDot");
  const text = document.getElementById("marketStatus");
  
  if (isOpen) {
    dot.classList.remove("market-closed");
    dot.classList.add("market-open");
    text.textContent = "Market Open";
  } else {
    dot.classList.remove("market-open");
    dot.classList.add("market-closed");
    text.textContent = "Market Closed";
  }
}

// Show output
function showOutput(text, type = "") {
  const output = document.getElementById("output");
  output.textContent = text;
  output.className = type;
}

// Set command
function setCommand(element) {
  document.getElementById("cmd").value = element.textContent;
}

// Test connection and start auto-refresh
async function testConnection() {
  try {
    const res = await fetch(`${API_URL}/`);
    const data = await res.json();
    
    if (data.status === "online") {
      updateStatus(true, "Connected");
      startAutoRefresh(); // Start automatic AJAX refresh
    }
  } catch (err) {
    updateStatus(false, "Connection Failed");
    showOutput(
      "‚úó Cannot connect to server!\n\n" +
      "Make sure FastAPI server is running:\n" +
      "uvicorn main:app --reload --port 8000",
      "error"
    );
  }
}

// Place trade
async function placeTrade() {
  const command = document.getElementById("cmd").value.trim();
  
  if (!command) {
    showOutput("‚ö† Please enter a trade command", "error");
    return;
  }

  showOutput("‚è≥ Placing trade...", "info");

  try {
    const res = await fetch(`${API_URL}/trade`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ command: command })
    });

    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput(
        "‚úó Trade Failed\n\n" +
        "Error: " + (data.error || data.message) + "\n\n" +
        JSON.stringify(data, null, 2),
        "error"
      );
    } else {
      showOutput(
        "‚úì Trade Placed Successfully!\n\n" +
        `Order ID: ${data.order_id}\n` +
        `Symbol: ${data.symbol}\n` +
        `Quantity: ${data.quantity}\n` +
        `Type: ${data.transaction_type}\n\n` +
        JSON.stringify(data, null, 2),
        "success"
      );
    }
  } catch (err) {
    showOutput("‚úó Request Failed\n\nError: " + err.message, "error");
  }
}

// Get quote
async function getQuote() {
  const command = document.getElementById("cmd").value.trim();
  const symbols = ["HDFCBANK", "ICICIBANK", "RELIANCE", "TCS", "INFY"];
  let symbol = null;
  
  for (let s of symbols) {
    if (command.toLowerCase().includes(s.toLowerCase().substring(0, 4))) {
      symbol = s;
      break;
    }
  }

  if (!symbol) {
    showOutput("‚ö† Cannot detect symbol", "error");
    return;
  }

  showOutput("‚è≥ Fetching quote for " + symbol + "...", "info");

  try {
    const res = await fetch(`${API_URL}/quote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symbol: symbol })
    });

    const data = await res.json();

    if (data.error || data.status === "error") {
      showOutput("‚úó Quote Fetch Failed\n\n" + JSON.stringify(data, null, 2), "error");
    } else {
      showOutput("‚úì Quote Retrieved!\n\n" + JSON.stringify(data, null, 2), "success");
    }
  } catch (err) {
    showOutput("‚úó Request Failed\n\nError: " + err.message, "error");
  }
}

// Get positions
async function getPositions() {
  showOutput("‚è≥ Fetching positions...", "info");
  try {
    const res = await fetch(`${API_URL}/positions`);
    const data = await res.json();
    if (data.error || data.status === "error") {
      showOutput("‚úó Failed\n\n" + JSON.stringify(data, null, 2), "error");
    } else {
      showOutput("‚úì Positions\n\n" + JSON.stringify(data, null, 2), "success");
    }
  } catch (err) {
    showOutput("‚úó Error: " + err.message, "error");
  }
}

// Get orders
async function getOrders() {
  showOutput("‚è≥ Fetching orders...", "info");
  try {
    const res = await fetch(`${API_URL}/orders`);
    const data = await res.json();
    if (data.error || data.status === "error") {
      showOutput("‚úó Failed\n\n" + JSON.stringify(data, null, 2), "error");
    } else {
      showOutput("‚úì Orders\n\n" + JSON.stringify(data, null, 2), "success");
    }
  } catch (err) {
    showOutput("‚úó Error: " + err.message, "error");
  }
}

// Initialize - Start auto-refresh on page load
window.addEventListener('load', () => {
  console.log("Page loaded - Starting auto-refresh...");
  testConnection();
});

// Cleanup - Stop auto-refresh when page is closed
window.addEventListener('beforeunload', () => {
  if (refreshIntervalId) {
    clearInterval(refreshIntervalId);
    console.log("Auto-refresh stopped");
  }
});
</script>

</body>
</html>